<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApiMessageController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Privacy Dashboard</a> &gt; <a href="index.source.html" class="el_package">com.privacydashboard.application.data.apiController</a> &gt; <span class="el_source">ApiMessageController.java</span></div><h1>ApiMessageController.java</h1><pre class="source lang-java linenums">package com.privacydashboard.application.data.apiController;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.privacydashboard.application.data.entity.Message;
import com.privacydashboard.application.data.entity.User;
import com.privacydashboard.application.data.service.DataBaseService;
import com.privacydashboard.application.security.UserDetailsServiceImpl;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.time.format.DateTimeParseException;
import java.util.List;

@RestController
<span class="fc" id="L21">public class ApiMessageController {</span>
    @Autowired
    private DataBaseService dataBaseService;
    @Autowired
    private UserDetailsServiceImpl userDetailsServiceImpl;
    @Autowired
    private ApiGeneralController apiGeneralController;

    /**
     * Get the message identified by the messageId
     * RESTRICTION: The one calling the function MUST BE the RECEIVER or SENDER of the message
     * @param messageId Id of the message
     * @return JSON with message information. Bad Request if ID invalid, user is not receiver or sender of the message
     */
    @GetMapping
    @RequestMapping(&quot;api/message/get&quot;)
    public ResponseEntity&lt;?&gt; get(@RequestParam() String messageId){
        try{
<span class="fc" id="L39">            Message message= apiGeneralController.getMessageFromId(messageId);</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">            if(!isSenderOrReceiver(message, apiGeneralController.getAuthenicatedUser())){</span>
<span class="fc" id="L41">                return ResponseEntity.badRequest().body(&quot;you must be sender or receiver of the message&quot;);</span>
            }
<span class="fc" id="L43">            JsonNode messageJson= apiGeneralController.createJsonFromMessage(message);</span>
<span class="fc" id="L44">            return ResponseEntity.ok(messageJson);</span>
<span class="fc" id="L45">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L46">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }
    }

    /**
     * Get all the messages between 2 users
     * RESTRICTION: The one calling the function MUST BE the one of the 2 users
     * @param user1Id one of the 2 users' id
     * @param user2Id one of the 2 users' id
     * @return Json containing all the messages between the 2 users. Bad Request if invalid IDs or users don't exist
     */
    @GetMapping
    @RequestMapping(&quot;api/message/getConversation&quot;)
    public ResponseEntity&lt;?&gt; getConversation(@RequestParam() String user1Id, @RequestParam() String user2Id){
        try{
<span class="pc bpc" id="L61" title="1 of 4 branches missed.">            if(!apiGeneralController.isAuthenticatedUserId(user1Id) &amp;&amp; !apiGeneralController.isAuthenticatedUserId(user2Id)){</span>
<span class="fc" id="L62">                return ResponseEntity.badRequest().body(&quot;you must be one of the two users&quot;);</span>
            }
<span class="fc" id="L64">            User user1= apiGeneralController.getUserFromId(user1Id);</span>
<span class="fc" id="L65">            User user2= apiGeneralController.getUserFromId(user2Id);</span>
<span class="fc" id="L66">            List&lt;Message&gt; conversation= dataBaseService.getConversationFromUsers(user1, user2);</span>
<span class="fc" id="L67">            ObjectMapper mapper = new ObjectMapper();</span>
<span class="fc" id="L68">            ArrayNode conversationArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">            for(Message message : conversation){</span>
<span class="fc" id="L70">                conversationArray.add(apiGeneralController.createJsonFromMessage(message));</span>
<span class="fc" id="L71">            }</span>
<span class="fc" id="L72">            return ResponseEntity.ok(conversationArray);</span>
<span class="fc" id="L73">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L74">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }
    }

    /**
     * Get all the messages of the user, divided by contacts
     * RESTRICTIONS: userId MUST represent the one calling the function
     * @param userId Id of the user to get messages from
     * @return JSON with all the messages, divided by contacts. Bad request if invalid ID, user is not authorized
     */
    @GetMapping
    @RequestMapping(&quot;api/message/getAllMessagesFromUser&quot;)
    public ResponseEntity&lt;?&gt; getAllMessagesFromUser(@RequestParam() String userId){
        try{
<span class="fc" id="L88">            User user= apiGeneralController.getUserFromId(userId);</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">            if(!apiGeneralController.isAuthenticatedUserId(userId)){</span>
<span class="fc" id="L90">                return ResponseEntity.badRequest().body(&quot;you must be the user identified by the userId&quot;);</span>
            }
<span class="fc" id="L92">            List&lt;User&gt; userList= dataBaseService.getUserConversationFromUser(user);</span>
<span class="fc" id="L93">            ObjectMapper mapper = new ObjectMapper();</span>
<span class="fc" id="L94">            ArrayNode allMessagesJson = mapper.createArrayNode();</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">            for(User contact : userList){</span>
<span class="fc" id="L96">                ObjectNode conversation= mapper.createObjectNode();</span>
<span class="fc" id="L97">                conversation.put(&quot;contactName&quot;, contact.getName());</span>
<span class="fc" id="L98">                ArrayNode conversationArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                for(Message message : dataBaseService.getConversationFromUsers(user, contact)){</span>
<span class="fc" id="L100">                    conversationArray.add(apiGeneralController.createJsonFromMessage(message));</span>
<span class="fc" id="L101">                }</span>
<span class="fc" id="L102">                conversation.set(&quot;messages&quot;, conversationArray);</span>
<span class="fc" id="L103">                allMessagesJson.add(conversation);</span>
<span class="fc" id="L104">            }</span>
<span class="fc" id="L105">            return ResponseEntity.ok(allMessagesJson);</span>
<span class="fc" id="L106">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L107">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }

    }

    /**
     * Send a new message
     * RESTRICTIONS: SenderId MUST represent the one calling the function
     * @param body the message to be sent
     * @return OK if message sent successfully. Bad Request if JSON invalid, users don't have app in common, user is not the sender
     */
    @PostMapping
    @RequestMapping(&quot;api/message/add&quot;)
    public ResponseEntity&lt;?&gt; add(@RequestBody() String body){
        try{
<span class="fc" id="L122">            Message message= apiGeneralController.getMessageFromJsonString(body);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            if(!apiGeneralController.getAuthenicatedUser().equals(message.getSender())){</span>
<span class="fc" id="L124">                return ResponseEntity.badRequest().body(&quot;you must be the sender of the message&quot;);</span>
            }
<span class="fc bfc" id="L126" title="All 2 branches covered.">            if(!dataBaseService.getAllContactsFromUser(message.getSender()).contains(message.getReceiver())){</span>
<span class="fc" id="L127">                return ResponseEntity.badRequest().body(&quot;the 2 users must have 1 app in common&quot;);</span>
            }
<span class="pc bpc" id="L129" title="1 of 4 branches missed.">            if(message.getId()!=null &amp;&amp; dataBaseService.getMessageFromID(message.getId()).isPresent()){</span>
<span class="fc" id="L130">                return ResponseEntity.badRequest().body(&quot;there is already a message with that ID&quot;);</span>
            }
<span class="fc bfc" id="L132" title="All 2 branches covered.">            if(message.getTime()==null){</span>
<span class="fc" id="L133">                dataBaseService.addNowMessage(message);</span>
            }
            else{
<span class="fc" id="L136">                dataBaseService.addMessage(message);</span>
            }
<span class="fc" id="L138">            return ResponseEntity.ok(&quot;Message sent successfully&quot;);</span>
<span class="fc" id="L139">        } catch (IllegalArgumentException | DateTimeParseException e){</span>
<span class="fc" id="L140">            return ResponseEntity.badRequest().body(e.getMessage());</span>
<span class="fc" id="L141">        } catch (IOException e){</span>
<span class="fc" id="L142">            return ResponseEntity.badRequest().body(&quot;invalid JSON&quot;);</span>
        }
    }

    private boolean isSenderOrReceiver(Message message, User user){
<span class="fc bfc" id="L147" title="All 4 branches covered.">        return message.getSender().equals(user) || message.getReceiver().equals(user);</span>
    }

    @ExceptionHandler(MissingServletRequestParameterException.class)
    public ResponseEntity&lt;?&gt; handleMissingParams(MissingServletRequestParameterException ex) {
<span class="nc" id="L152">        return ResponseEntity.badRequest().body(ex.getParameterName() + &quot; parameter is missing&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>