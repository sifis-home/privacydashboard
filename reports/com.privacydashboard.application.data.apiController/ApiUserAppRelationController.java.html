<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApiUserAppRelationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Privacy Dashboard</a> &gt; <a href="index.source.html" class="el_package">com.privacydashboard.application.data.apiController</a> &gt; <span class="el_source">ApiUserAppRelationController.java</span></div><h1>ApiUserAppRelationController.java</h1><pre class="source lang-java linenums">package com.privacydashboard.application.data.apiController;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.privacydashboard.application.data.entity.IoTApp;
import com.privacydashboard.application.data.entity.User;
import com.privacydashboard.application.data.entity.UserAppRelation;
import com.privacydashboard.application.data.service.DataBaseService;
import com.privacydashboard.application.security.AuthenticatedUser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.io.StringReader;
import java.util.LinkedList;
import java.util.List;

@RestController
<span class="fc" id="L22">public class ApiUserAppRelationController {</span>

    @Autowired
    private DataBaseService dataBaseService;
    @Autowired
    private AuthenticatedUser authenticatedUser;
    @Autowired
    private ApiGeneralController apiGeneralController;

    /**
     * Get information about relation between user and app
     * RESTRICTIONS: Controller/DPO of the app or userId must belong to the one calling this function
     * @param userId ID of the user
     * @param appId ID of the app
     * @return Json with information about relation between user and app. Bad Request if Id not valid or not allowed to get information
     */
    @GetMapping
    @RequestMapping(&quot;api/userapprelation/get&quot;)
    public ResponseEntity&lt;?&gt; get(@RequestParam() String userId, @RequestParam() String appId){
        try{
<span class="fc bfc" id="L42" title="All 2 branches covered.">            if(!apiGeneralController.userHasApp(apiGeneralController.getAuthenicatedUser(), apiGeneralController.getAppFromId(appId))){</span>
<span class="fc" id="L43">                return ResponseEntity.badRequest().body(&quot;you must be connected with the app&quot;);</span>
            }
<span class="pc bpc" id="L45" title="1 of 4 branches missed.">            if(!apiGeneralController.isAuthenticatedUserId(userId) &amp;&amp; !apiGeneralController.isControllerOrDpo(true, null)){</span>
<span class="fc" id="L46">                return ResponseEntity.badRequest().body(&quot;you must be the user identified by the userId or the controller/DPO of the app&quot;);</span>
            }

<span class="fc" id="L49">            UserAppRelation userAppRelation= apiGeneralController.getUserAppRelationByUserIdAndAppId(userId, appId);</span>
<span class="fc" id="L50">            ObjectNode userAppRelationJson= apiGeneralController.createJsonFromUserAppRelation(userAppRelation);</span>
<span class="fc" id="L51">            return ResponseEntity.ok(userAppRelationJson);</span>
<span class="fc" id="L52">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L53">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }
    }

    /**
     * Associate a user with an app
     * RESTRICTIONS: userId must belong to the one calling this function
     * @param userId ID of the User
     * @param appId ID of the app
     * @return OK if relation added successfully. Bad request if IDs invalid, user or app does not exist, user already has app, user is not the one calling this function
     */
    @PostMapping
    @RequestMapping(&quot;api/userapprelation/add&quot;)
    public ResponseEntity&lt;?&gt; add(@RequestParam() String userId, @RequestParam() String appId){
        try{
<span class="fc" id="L68">            User user=apiGeneralController.getUserFromId(userId);</span>
<span class="fc" id="L69">            IoTApp app=apiGeneralController.getAppFromId(appId);</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">            if(!apiGeneralController.isAuthenticatedUserId(userId)){</span>
<span class="fc" id="L71">                return ResponseEntity.badRequest().body(&quot;you must be the user identified by the userId&quot;);</span>
            }
<span class="fc bfc" id="L73" title="All 2 branches covered.">            if(!apiGeneralController.userHasApp(user,app)){</span>
<span class="fc" id="L74">                dataBaseService.addUserApp(user, app);</span>
<span class="fc" id="L75">                return ResponseEntity.ok(&quot;app added successfully&quot;);</span>
            }
            else{
<span class="fc" id="L78">                return ResponseEntity.badRequest().body(&quot;user already has this app&quot;);</span>
            }
<span class="fc" id="L80">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L81">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }
    }

    /**
     * Add some consenses for the user identified with userId in the app identified with the appId
     * RESTRICTIONS: The one calling the function MUST be controller/DPO of the app
     * @param userId ID of the user
     * @param appId ID of the app
     * @param body JSON representing the consenses to add
     * @return OK if successfully added. Bad Request if user or app don't exist, invalid JSON, not authorized
     */
    @PostMapping
    @RequestMapping(&quot;api/userapprelation/addConsenses&quot;)
    public ResponseEntity&lt;?&gt; addConsenses(@RequestParam() String userId, @RequestParam() String appId, @RequestBody() String body){
        try{
<span class="fc" id="L97">            IoTApp app= apiGeneralController.getAppFromId(appId);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">            if(!apiGeneralController.isControllerOrDpo(true, null)){</span>
<span class="fc" id="L99">                return ResponseEntity.badRequest().body(&quot;You must be a controller/DPO&quot;);</span>
            }
<span class="fc bfc" id="L101" title="All 2 branches covered.">            if(!apiGeneralController.userHasApp(apiGeneralController.getAuthenicatedUser(), app)){</span>
<span class="fc" id="L102">                return ResponseEntity.badRequest().body(&quot;you must be connected with the app&quot;);</span>
            }
<span class="fc" id="L104">            UserAppRelation userAppRelation= apiGeneralController.getUserAppRelationByUserIdAndAppId(userId, appId);</span>

<span class="nc" id="L106">            JsonNode rootNode = new ObjectMapper().readTree(new StringReader(body));</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">            if(!rootNode.has(&quot;consenses&quot;) || !rootNode.isArray()){</span>
<span class="nc" id="L108">                return ResponseEntity.badRequest().body(&quot;invalid JSON&quot;);</span>
            }
<span class="nc" id="L110">            List&lt;String&gt; newConsenses= new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            for (JsonNode consens : rootNode.get(&quot;consenses&quot;)) {</span>
<span class="nc" id="L112">                newConsenses.add(consens.asText());</span>
<span class="nc" id="L113">            }</span>
<span class="nc" id="L114">            dataBaseService.addConsenses(userAppRelation, newConsenses);</span>
<span class="nc" id="L115">            return ResponseEntity.ok(&quot;consenses added successfully&quot;);</span>
<span class="fc" id="L116">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L117">            return ResponseEntity.badRequest().body(e.getMessage());</span>
<span class="fc" id="L118">        } catch (IOException e){</span>
<span class="fc" id="L119">            return ResponseEntity.badRequest().body(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * Dissociate a user with an app
     * RESTRICTIONS: userId must belong to the one calling this function
     * @param userId ID of the User
     * @param appId ID of the App
     * @return OK if relation deleted successfully. Bad request if IDs invalid, user or app does not exist, user does not have app, user is not the one calling this function
     */
    @DeleteMapping
    @RequestMapping(&quot;api/userapprelation/delete&quot;)
    public ResponseEntity&lt;?&gt; delete(@RequestParam() String userId, @RequestParam() String appId){
        try{
<span class="fc" id="L134">            User user=apiGeneralController.getUserFromId(userId);</span>
<span class="fc" id="L135">            IoTApp app=apiGeneralController.getAppFromId(appId);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            if(!apiGeneralController.isAuthenticatedUserId(userId)){</span>
<span class="fc" id="L137">                return ResponseEntity.badRequest().body(&quot;you must be the user identified by the userId&quot;);</span>
            }

<span class="pc bpc" id="L140" title="1 of 4 branches missed.">            if(apiGeneralController.userHasApp(user,app) &amp;&amp; dataBaseService.deleteAppFromUser(user, app)){</span>
<span class="fc" id="L141">                return ResponseEntity.ok(&quot;app removed successfully&quot;);</span>
            }
            else{
<span class="fc" id="L144">                return ResponseEntity.badRequest().body(&quot;user doesn't have this app&quot;);</span>
            }
<span class="fc" id="L146">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L147">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }
    }

    /**
     * Remove some consenses for the user identified with userId in the app identified with the appId
     * RESTRICTIONS: The one calling the function MUST be controller/DPO of the app
     * @param userId ID of the user
     * @param appId ID of the app
     * @param body JSON representing the consenses to remove
     * @return OK if successfully removed. Bad Request if user or app don't exist, invalid JSON, not authorized
     */
    @DeleteMapping
    @RequestMapping(&quot;api/userapprelation/removeConsenses&quot;)
    public ResponseEntity&lt;?&gt; removeConsenses(@RequestParam() String userId, @RequestParam() String appId, @RequestBody() String body){
        try{
<span class="fc" id="L163">            IoTApp app= apiGeneralController.getAppFromId(appId);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">            if(!apiGeneralController.isControllerOrDpo(true, null)){</span>
<span class="fc" id="L165">                return ResponseEntity.badRequest().body(&quot;You must be a controller/DPO&quot;);</span>
            }
<span class="fc bfc" id="L167" title="All 2 branches covered.">            if(!apiGeneralController.userHasApp(apiGeneralController.getAuthenicatedUser(), app)){</span>
<span class="fc" id="L168">                return ResponseEntity.badRequest().body(&quot;you must be connected with the app&quot;);</span>
            }
<span class="fc" id="L170">            UserAppRelation userAppRelation= apiGeneralController.getUserAppRelationByUserIdAndAppId(userId, appId);</span>

<span class="nc" id="L172">            JsonNode rootNode = new ObjectMapper().readTree(new StringReader(body));</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">            if(!rootNode.has(&quot;consenses&quot;) || !rootNode.isArray()){</span>
<span class="nc" id="L174">                return ResponseEntity.badRequest().body(&quot;invalid JSON&quot;);</span>
            }
<span class="nc" id="L176">            List&lt;String&gt; newConsenses= new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            for (JsonNode consens : rootNode.get(&quot;consenses&quot;)) {</span>
<span class="nc" id="L178">                newConsenses.add(consens.asText());</span>
<span class="nc" id="L179">            }</span>
<span class="nc" id="L180">            dataBaseService.removeConsensesFromUserAppRelation(userAppRelation, newConsenses);</span>
<span class="nc" id="L181">            return ResponseEntity.ok(&quot;consenses removed successfully&quot;);</span>
<span class="fc" id="L182">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L183">            return ResponseEntity.badRequest().body(e.getMessage());</span>
<span class="fc" id="L184">        } catch (IOException e){</span>
<span class="fc" id="L185">            return ResponseEntity.badRequest().body(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * Remove all the consenses for the user identified with userId in the app identified with the appId
     * RESTRICTIONS: The one calling the function MUST be controller/DPO of the app
     * @param userId ID of the user
     * @param appId ID of the app
     * @return OK if successfully removed. Bad Request if user or app don't exist, invalid JSON, not authorized
     */
    @DeleteMapping
    @RequestMapping(&quot;api/userapprelation/removeAllConsenses&quot;)
    public ResponseEntity&lt;?&gt; removeAllConsenses(@RequestParam() String userId, @RequestParam() String appId){
        try{
<span class="fc" id="L200">            IoTApp app= apiGeneralController.getAppFromId(appId);</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">            if(!apiGeneralController.isControllerOrDpo(true, null)){</span>
<span class="fc" id="L202">                return ResponseEntity.badRequest().body(&quot;You must be a controller/DPO&quot;);</span>
            }
<span class="fc bfc" id="L204" title="All 2 branches covered.">            if(!apiGeneralController.userHasApp(apiGeneralController.getAuthenicatedUser(), app)){</span>
<span class="fc" id="L205">                return ResponseEntity.badRequest().body(&quot;you must be connected with the app&quot;);</span>
            }
<span class="fc" id="L207">            UserAppRelation userAppRelation= apiGeneralController.getUserAppRelationByUserIdAndAppId(userId, appId);</span>
<span class="fc" id="L208">            dataBaseService.removeAllConsenses(userAppRelation);</span>
<span class="fc" id="L209">            return ResponseEntity.ok(&quot;consenses removed successfully&quot;);</span>
<span class="fc" id="L210">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L211">            return ResponseEntity.badRequest().body(e.getMessage());</span>
        }
    }

    @ExceptionHandler(MissingServletRequestParameterException.class)
    public ResponseEntity&lt;?&gt; handleMissingParams(MissingServletRequestParameterException ex) {
<span class="nc" id="L217">        return ResponseEntity.badRequest().body(ex.getParameterName() + &quot; parameter is missing&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>