<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApiGeneralController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Privacy Dashboard</a> &gt; <a href="index.source.html" class="el_package">com.privacydashboard.application.data.apiController</a> &gt; <span class="el_source">ApiGeneralController.java</span></div><h1>ApiGeneralController.java</h1><pre class="source lang-java linenums">package com.privacydashboard.application.data.apiController;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.privacydashboard.application.data.GlobalVariables;
import com.privacydashboard.application.data.GlobalVariables.QuestionnaireVote;
import com.privacydashboard.application.data.GlobalVariables.RightType;
import com.privacydashboard.application.data.GlobalVariables.Role;
import com.privacydashboard.application.data.entity.*;
import com.privacydashboard.application.data.service.DataBaseService;
import com.privacydashboard.application.security.AuthenticatedUser;
import com.privacydashboard.application.security.UserDetailsServiceImpl;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.io.StringReader;
import java.time.LocalDateTime;
import java.time.format.DateTimeParseException;
import java.util.Hashtable;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Service
<span class="fc" id="L28">public class ApiGeneralController {</span>
    @Autowired
    private AuthenticatedUser authenticatedUser;
    @Autowired
    private DataBaseService dataBaseService;
    @Autowired
    private UserDetailsServiceImpl userDetailsServiceImpl;

<span class="fc" id="L36">    private final ObjectMapper mapper = new ObjectMapper();</span>

    // BOOLEAN CONTROLS

    public boolean isAuthenticatedUserId(String uuid) {
<span class="fc" id="L41">        Optional&lt;User&gt; maybeUser = dataBaseService.getUser(UUID.fromString(uuid));</span>
<span class="fc" id="L42">        Optional&lt;User&gt; maybeAuthenticate = authenticatedUser.get();</span>
<span class="fc bfc" id="L43" title="All 4 branches covered.">        if (maybeUser.isPresent() &amp;&amp; maybeAuthenticate.isPresent()) {</span>
<span class="fc" id="L44">            return maybeUser.get().equals(maybeAuthenticate.get());</span>
        }
<span class="fc" id="L46">        return false;</span>
    }

    public boolean isControllerOrDpo(boolean considerAuthenticatedUser, String uuid) {
        Optional&lt;User&gt; maybeUser;
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (considerAuthenticatedUser) {</span>
<span class="fc" id="L52">            maybeUser = authenticatedUser.get();</span>
        } else {
<span class="fc" id="L54">            maybeUser = dataBaseService.getUser(UUID.fromString(uuid));</span>
        }
<span class="fc bfc" id="L56" title="All 4 branches covered.">        return maybeUser.filter(user -&gt; (user.getRole().equals(Role.CONTROLLER) || user.getRole().equals(Role.DPO))).isPresent();</span>
    }

    public boolean userHasApp(User user, IoTApp app) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        return (dataBaseService.getUserAppRelationByUserAndApp(user, app) != null);</span>
    }

    // GET OBJECTS

    /**
     * @return the authenticate user
     * @throws IllegalArgumentException if there is no authenticated user
     */
    public User getAuthenicatedUser() throws IllegalArgumentException {
<span class="fc" id="L70">        Optional&lt;User&gt; maybeUser = authenticatedUser.get();</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (maybeUser.isPresent()) {</span>
<span class="fc" id="L72">            return maybeUser.get();</span>
        } else {
<span class="fc" id="L74">            throw new IllegalArgumentException(&quot;No authenticated user&quot;);</span>
        }
    }

    /**
     * @param uuid the ID of the User
     * @return the User with that ID
     * @throws IllegalArgumentException If ID is an invalid UUID
     * @throws IllegalArgumentException If user with that ID does not exist
     */
    public User getUserFromId(String uuid) throws IllegalArgumentException {
        try {
<span class="fc" id="L86">            Optional&lt;User&gt; maybeUser = dataBaseService.getUser(UUID.fromString(uuid));</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">            if (maybeUser.isPresent()) {</span>
<span class="fc" id="L88">                return maybeUser.get();</span>
            } else {
<span class="fc" id="L90">                throw new IllegalArgumentException(&quot;user does not exist&quot;);</span>
            }
<span class="fc" id="L92">        } catch (IllegalArgumentException e){</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            if(e.getMessage().equals(&quot;user does not exist&quot;))</span>
<span class="fc" id="L94">                throw e;</span>
            else
<span class="fc" id="L96">                throw new IllegalArgumentException(&quot;invalid ID&quot;);</span>
        }
    }

    /**
     * @param uuid the ID of the app
     * @return the app with that ID
     * @throws IllegalArgumentException If ID is an invalid UUID
     * @throws IllegalArgumentException If app with that ID does not exist
     */
    public IoTApp getAppFromId(String uuid) throws IllegalArgumentException {
        try {
<span class="fc" id="L108">            Optional&lt;IoTApp&gt; maybeApp = dataBaseService.getApp(UUID.fromString(uuid));</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">            if (maybeApp.isPresent()) {</span>
<span class="fc" id="L110">                return maybeApp.get();</span>
            } else {
<span class="fc" id="L112">                throw new IllegalArgumentException(&quot;app does not exist&quot;);</span>
            }
<span class="fc" id="L114">        } catch (IllegalArgumentException e){</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            if(e.getMessage().equals(&quot;app does not exist&quot;))</span>
<span class="fc" id="L116">                throw e;</span>
            else
<span class="fc" id="L118">                throw new IllegalArgumentException(&quot;invalid ID&quot;);</span>
        }
    }

    public Message getMessageFromId(String uuid) throws IllegalArgumentException {
        try {
<span class="fc" id="L124">            Optional&lt;Message&gt; message = dataBaseService.getMessageFromID(UUID.fromString(uuid));</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">            if (message.isPresent()) {</span>
<span class="fc" id="L126">                return message.get();</span>
            } else {
<span class="fc" id="L128">                throw new IllegalArgumentException(&quot;message does not exist&quot;);</span>
            }
<span class="fc" id="L130">        } catch (IllegalArgumentException e){</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            if(e.getMessage().equals(&quot;message does not exist&quot;))</span>
<span class="fc" id="L132">                throw e;</span>
            else
<span class="fc" id="L134">                throw new IllegalArgumentException(&quot;invalid ID&quot;);</span>
        }
    }

    /**
     * @param userId the ID of the user
     * @param appId  the ID of the app
     * @return the object UserAppRelation
     * @throws IllegalArgumentException if IDs invalid, user or app does not exist, user does not have the app
     */
    public UserAppRelation getUserAppRelationByUserIdAndAppId(String userId, String appId) throws IllegalArgumentException {
<span class="fc" id="L145">        User user = getUserFromId(userId);</span>
<span class="fc" id="L146">        IoTApp app = getAppFromId(appId);</span>
<span class="fc" id="L147">        UserAppRelation userAppRelation = dataBaseService.getUserAppRelationByUserAndApp(user, app);</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (userAppRelation == null) {</span>
<span class="fc" id="L149">            throw new IllegalArgumentException(&quot;user does not have this app&quot;);</span>
        }
<span class="fc" id="L151">        return userAppRelation;</span>
    }

    /**
     * @param privacyNoticeId ID of the privacy notice
     * @return privacy notice
     * @throws IllegalArgumentException if IDs invalid, privacy notice does not exist
     */
    public PrivacyNotice getPrivacyNoticeFromId(String privacyNoticeId) throws IllegalArgumentException {
        try {
<span class="fc" id="L161">            Optional&lt;PrivacyNotice&gt; privacyNotice = dataBaseService.getPrivacyNoticeFromId(UUID.fromString(privacyNoticeId));</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            if (privacyNotice.isPresent()) {</span>
<span class="fc" id="L163">                return privacyNotice.get();</span>
            } else {
<span class="fc" id="L165">                throw new IllegalArgumentException(&quot;privacy notice does not exist&quot;);</span>
            }
<span class="fc" id="L167">        } catch (IllegalArgumentException e){</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            if(e.getMessage().equals(&quot;privacy notice does not exist&quot;))</span>
<span class="fc" id="L169">                throw e;</span>
            else
<span class="fc" id="L171">                throw new IllegalArgumentException(&quot;invalid ID&quot;);</span>
        }
    }

    /**
     * @param appId ID of the app of the privacy notice
     * @return privacy notice
     * @throws IllegalArgumentException if IDs invalid, app does not exist, privacy notice does not exist
     */
    public PrivacyNotice getPrivacyNoticeFromAppId(String appId) throws IllegalArgumentException {
<span class="fc" id="L181">        PrivacyNotice privacyNotice = dataBaseService.getPrivacyNoticeFromApp(getAppFromId(appId));</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (privacyNotice == null) {</span>
<span class="fc" id="L183">            throw new IllegalArgumentException(&quot;privacy notice does not exist&quot;);</span>
        } else {
<span class="fc" id="L185">            return privacyNotice;</span>
        }
    }

    /**
     * @param notificationId ID of the Notification
     * @return notification
     * @throws IllegalArgumentException if IDs invalid, notification does not exist
     */
    public Notification getNotificationFromId(String notificationId) throws IllegalArgumentException {
        try {
<span class="fc" id="L196">            Optional&lt;Notification&gt; notification = dataBaseService.getNotificationFromId(UUID.fromString(notificationId));</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">            if (notification.isPresent()) {</span>
<span class="fc" id="L198">                return notification.get();</span>
            } else {
<span class="fc" id="L200">                throw new IllegalArgumentException(&quot;notification does not exist&quot;);</span>
            }
<span class="fc" id="L202">        } catch (IllegalArgumentException e){</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">            if(e.getMessage().equals(&quot;notification does not exist&quot;))</span>
<span class="fc" id="L204">                throw e;</span>
            else
<span class="fc" id="L206">                throw new IllegalArgumentException(&quot;invalid ID&quot;);</span>
        }
    }

    /**
     * @param requestId ID of the RightRequest
     * @return RightRequest
     * @throws IllegalArgumentException if IDs invalid, RightRequest does not exist
     */
    public RightRequest getRequestFromId(String requestId) throws IllegalArgumentException {
        try {
<span class="fc" id="L217">            RightRequest request = dataBaseService.getRequestFromId(UUID.fromString(requestId));</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">            if (request == null) {</span>
<span class="fc" id="L219">                throw new IllegalArgumentException(&quot;Right Request does not exist&quot;);</span>
            } else {
<span class="fc" id="L221">                return request;</span>
            }
<span class="fc" id="L223">        } catch (IllegalArgumentException e){</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">            if(e.getMessage().equals(&quot;Right Request does not exist&quot;))</span>
<span class="fc" id="L225">                throw e;</span>
            else
<span class="fc" id="L227">                throw new IllegalArgumentException(&quot;invalid ID&quot;);</span>
        }
    }

    // MANAGE JSON OBJECTS
    // App

    /**
     * @param app the app to be represented as a JSON. It MUST contain the ID and the NAME
     * @return the JSON object representing the app
     * @throws IllegalArgumentException If IoTApp object is null
     * @throws IllegalArgumentException If IoTApp object has not an ID
     * @throws IllegalArgumentException If IoTApp object has not a name
     */
    public ObjectNode createJsonFromApp(IoTApp app) throws IllegalArgumentException {
<span class="fc" id="L242">        ObjectNode appJson = mapper.createObjectNode();</span>

<span class="pc bpc" id="L244" title="1 of 6 branches missed.">        if (app == null || app.getId() == null || app.getName() == null) {</span>
<span class="fc" id="L245">            throw new IllegalArgumentException(&quot;invalid app&quot;);</span>
        }
<span class="fc" id="L247">        appJson.put(&quot;id&quot;, app.getId().toString());</span>
<span class="fc" id="L248">        appJson.put(&quot;name&quot;, app.getName());</span>

<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (app.getDescription() != null) {</span>
<span class="fc" id="L251">            appJson.put(&quot;description&quot;, app.getDescription());</span>
        }

<span class="fc bfc" id="L254" title="All 2 branches covered.">        if (app.getQuestionnaireVote() != null) {</span>
<span class="fc" id="L255">            appJson.put(&quot;questionnaireVote&quot;, app.getQuestionnaireVote().toString());</span>
        }

<span class="fc bfc" id="L258" title="All 2 branches covered.">        if (app.getDetailVote() != null) {</span>
<span class="fc" id="L259">            ArrayNode detailVoteArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">            for (String answer : app.getDetailVote()) {</span>
<span class="fc" id="L261">                detailVoteArray.add(answer);</span>
            }
<span class="fc" id="L263">            appJson.set(&quot;detailVote&quot;, detailVoteArray);</span>
        }

<span class="fc bfc" id="L266" title="All 2 branches covered.">        if (app.getOptionalAnswers() != null) {</span>
<span class="fc" id="L267">            ArrayNode optionalAnswersArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L268" title="All 2 branches covered.">            for (int i = 0; i &lt; GlobalVariables.nQuestions; i++) {</span>
<span class="fc" id="L269">                optionalAnswersArray.add(app.getOptionalAnswers().get(i));</span>

            }
<span class="fc" id="L272">            appJson.set(&quot;optionalAnswers&quot;, optionalAnswersArray);</span>
        }
<span class="fc" id="L274">        return appJson;</span>
    }

    /**
     * @param nameMandatory specify if the name MUST be included (true) or not (false)
     * @param body          the JSON body from the POST request
     * @return the app object represented by the JSON
     * @throws IOException              If body is not a valid JSON
     * @throws IllegalArgumentException If the JSON does not contain name
     * @throws IllegalArgumentException If the indicated ID is an invalid UUID
     */
    public IoTApp getAppFromJsonString(boolean nameMandatory, String body) throws IOException, IllegalArgumentException {
        try{
<span class="fc" id="L287">            JsonNode rootNode = mapper.readTree(new StringReader(body));</span>
<span class="fc" id="L288">            return getAppFromJsonNode(nameMandatory, rootNode);</span>
<span class="fc" id="L289">        } catch (IOException e){</span>
<span class="fc" id="L290">            throw new IOException(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * @param nameMandatory specify if the name MUST be included (true) or not (false)
     * @param node          the JSON object to be turned into an app object.
     * @return the app object represented by the JSON
     * @throws IllegalArgumentException If the JSON does not contain name
     * @throws IllegalArgumentException If the indicated ID is an invalid UUID
     */
    public IoTApp getAppFromJsonNode(boolean nameMandatory, JsonNode node) throws IllegalArgumentException {
<span class="fc" id="L302">        IoTApp app = new IoTApp();</span>

<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (node.has(&quot;name&quot;)) {</span>
<span class="fc" id="L305">            app.setName(node.get(&quot;name&quot;).asText());</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">        } else if (nameMandatory) {</span>
<span class="fc" id="L307">            throw new IllegalArgumentException(&quot;JSON incomplete&quot;);</span>
        }


<span class="fc bfc" id="L311" title="All 2 branches covered.">        if (node.has(&quot;id&quot;)) {</span>
<span class="fc" id="L312">            app.setId(UUID.fromString(node.get(&quot;id&quot;).asText()));</span>
        }
        
        //Codice originale, setta l'id con la descrizione
        /*if (node.has(&quot;description&quot;)) {
            app.setId(UUID.fromString(node.get(&quot;description&quot;).asText()));
        }*/

        //Codice aggiornato, descrizione settata con la descrizione
<span class="fc bfc" id="L321" title="All 2 branches covered.">        if (node.has(&quot;description&quot;)) {</span>
<span class="fc" id="L322">            app.setDescription(node.get(&quot;description&quot;).asText());</span>
        }


<span class="fc bfc" id="L326" title="All 2 branches covered.">        if (node.has(&quot;questionnaireVote&quot;)) {</span>
<span class="pc bpc" id="L327" title="1 of 4 branches missed.">            switch (node.get(&quot;questionnaireVote&quot;).asText()) {</span>
                case &quot;RED&quot;:
<span class="fc" id="L329">                    app.setQuestionnaireVote(QuestionnaireVote.RED);</span>
<span class="fc" id="L330">                    break;</span>
                case &quot;ORANGE&quot;:
<span class="fc" id="L332">                    app.setQuestionnaireVote(QuestionnaireVote.ORANGE);</span>
<span class="fc" id="L333">                    break;</span>
                case &quot;GREEN&quot;:
<span class="fc" id="L335">                    app.setQuestionnaireVote(QuestionnaireVote.GREEN);</span>
                    break;

            }
        }

<span class="fc bfc" id="L341" title="All 2 branches covered.">        if (node.has(&quot;detailVote&quot;)) {</span>
<span class="fc" id="L342">            JsonNode detailVote = node.get(&quot;detailVote&quot;);</span>
<span class="fc bfc" id="L343" title="All 2 branches covered.">            if (detailVote.isArray()) {</span>
<span class="fc" id="L344">                String[] detailVoteArray = new String[GlobalVariables.nQuestions];</span>
<span class="fc" id="L345">                int i = 0;</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">                for (JsonNode singleAnswer : detailVote) {</span>
<span class="fc" id="L347">                    detailVoteArray[i] = singleAnswer.asText();</span>
<span class="fc" id="L348">                    i++;</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">                    if (i &gt;= GlobalVariables.nQuestions) {</span>
<span class="fc" id="L350">                        break;</span>
                    }
<span class="fc" id="L352">                }</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">                if (i &lt; GlobalVariables.nQuestions) {</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">                    for (int j = i; j &lt; GlobalVariables.nQuestions; j++) {</span>
<span class="fc" id="L355">                        detailVoteArray[j] = null;</span>
                    }
                }
<span class="fc" id="L358">                app.setDetailVote(detailVoteArray);</span>
            }
        }

<span class="fc bfc" id="L362" title="All 2 branches covered.">        if (node.has(&quot;optionalAnswers&quot;)) {</span>
<span class="fc" id="L363">            JsonNode optionalAnswers = node.get(&quot;optionalAnswers&quot;);</span>
<span class="fc bfc" id="L364" title="All 2 branches covered.">            if (optionalAnswers.isArray()) {</span>
<span class="fc" id="L365">                Hashtable&lt;Integer, String&gt; optionalAnswersHash = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L366">                int i = 0;</span>
<span class="fc bfc" id="L367" title="All 2 branches covered.">                for (JsonNode singleAnswer : optionalAnswers) {</span>
<span class="fc" id="L368">                    optionalAnswersHash.put(i, singleAnswer.asText());</span>
<span class="fc" id="L369">                    i++;</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">                    if (i &gt;= GlobalVariables.nQuestions) {</span>
<span class="fc" id="L371">                        break;</span>
                    }
<span class="fc" id="L373">                }</span>
<span class="fc" id="L374">                app.setOptionalAnswers(optionalAnswersHash);</span>
            }
        }
<span class="fc" id="L377">        return app;</span>
    }

    // User

    /**
     * @param user the user to be represented as a JSON. It MUST contain the ID, NAME, ROLE and PASSWORD
     * @return the JSON object representing the user
     * @throws IllegalArgumentException If User object is null
     * @throws IllegalArgumentException If User object has not an ID, name, role or password
     */
    public ObjectNode createJsonFromUser(User user) throws IllegalArgumentException {
<span class="fc" id="L389">        ObjectNode userJson = mapper.createObjectNode();</span>

<span class="pc bpc" id="L391" title="1 of 10 branches missed.">        if (user == null || user.getId() == null || user.getName() == null || user.getHashedPassword() == null || user.getRole() == null) {</span>
<span class="fc" id="L392">            throw new IllegalArgumentException(&quot;invalid user&quot;);</span>
        }
<span class="fc" id="L394">        userJson.put(&quot;id&quot;, user.getId().toString());</span>
<span class="fc" id="L395">        userJson.put(&quot;name&quot;, user.getName());</span>
<span class="fc" id="L396">        userJson.put(&quot;role&quot;, user.getRole().toString());</span>
<span class="fc" id="L397">        userJson.put(&quot;hashedPassword&quot;, user.getHashedPassword());</span>

<span class="fc bfc" id="L399" title="All 2 branches covered.">        if (user.getMail() != null) {</span>
<span class="fc" id="L400">            userJson.put(&quot;mail&quot;, user.getMail());</span>
        }

<span class="fc" id="L403">        return userJson;</span>
    }

    /**
     * @param parametersMandatory specify if the name, role and password MUST be included (true) or not (false)
     * @param body                the JSON body from the POST request
     * @return the user object represented by the JSON
     * @throws IOException              If body is not a valid JSON
     * @throws IllegalArgumentException If the JSON does not contain name, role or password
     * @throws IllegalArgumentException If the indicated ID is an invalid UUID
     */
    public User getUserFromJsonString(boolean parametersMandatory, String body) throws IllegalArgumentException, IOException {
        try {
<span class="fc" id="L416">            JsonNode rootNode = mapper.readTree(new StringReader(body));</span>
<span class="fc" id="L417">            return getUserFromJsonNode(parametersMandatory, rootNode);</span>
<span class="fc" id="L418">        } catch (IOException e){</span>
<span class="fc" id="L419">            throw new IOException(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * @param parametersMandatory specify if the name, role and password MUST be included (true) or not (false)
     * @param node                the JSON object to be turned into a user object.
     * @return the user object represented by the JSON
     * @throws IllegalArgumentException If the JSON does not contain name, role or password
     * @throws IllegalArgumentException If the indicated ID is an invalid UUID
     */
    public User getUserFromJsonNode(boolean parametersMandatory, JsonNode node) throws IllegalArgumentException {
<span class="fc" id="L431">        User user = new User();</span>

<span class="fc bfc" id="L433" title="All 2 branches covered.">        if (node.has(&quot;name&quot;)) {</span>
<span class="fc" id="L434">            user.setName(node.get(&quot;name&quot;).asText());</span>
<span class="fc bfc" id="L435" title="All 2 branches covered.">        } else if (parametersMandatory) {</span>
<span class="fc" id="L436">            throw new IllegalArgumentException(&quot;JSON incomplete&quot;);</span>
        }

<span class="fc bfc" id="L439" title="All 2 branches covered.">        if (node.has(&quot;password&quot;)) {</span>
<span class="fc" id="L440">            user.setHashedPassword(userDetailsServiceImpl.hashPass(node.get(&quot;password&quot;).asText()));</span>
<span class="fc bfc" id="L441" title="All 2 branches covered.">        } else if (parametersMandatory) {</span>
<span class="fc" id="L442">            throw new IllegalArgumentException(&quot;JSON incomplete&quot;);</span>
        }

<span class="fc bfc" id="L445" title="All 2 branches covered.">        if (node.has(&quot;role&quot;)) {</span>
<span class="pc bpc" id="L446" title="1 of 4 branches missed.">            switch (node.get(&quot;role&quot;).asText()) {</span>
                case &quot;SUBJECT&quot;:
<span class="fc" id="L448">                    user.setRole(Role.SUBJECT);</span>
<span class="fc" id="L449">                    break;</span>
                case &quot;CONTROLLER&quot;:
<span class="fc" id="L451">                    user.setRole(Role.CONTROLLER);</span>
<span class="fc" id="L452">                    break;</span>
                case &quot;DPO&quot;:
<span class="fc" id="L454">                    user.setRole(Role.DPO);</span>
                    break;
<span class="fc" id="L456">            }</span>
<span class="fc bfc" id="L457" title="All 2 branches covered.">        } else if (parametersMandatory) {</span>
<span class="fc" id="L458">            throw new IllegalArgumentException(&quot;JSON incomplete&quot;);</span>
        }

<span class="fc bfc" id="L461" title="All 2 branches covered.">        if (node.has(&quot;id&quot;)) {</span>
<span class="fc" id="L462">            user.setId(UUID.fromString(node.get(&quot;id&quot;).asText()));</span>
        }

<span class="fc bfc" id="L465" title="All 2 branches covered.">        if (node.has(&quot;mail&quot;)) {</span>
<span class="fc" id="L466">            user.setMail(node.get(&quot;mail&quot;).asText());</span>
        }

<span class="fc" id="L469">        return user;</span>
    }

    // UserAppRelation

    /**
     * @param userAppRelation object to be transformed in JSON
     * @return JSON representing the object
     * @throws IllegalArgumentException if invalid object
     */
    public ObjectNode createJsonFromUserAppRelation(UserAppRelation userAppRelation) throws IllegalArgumentException {
<span class="fc" id="L480">        ObjectNode userAppRelationJson = mapper.createObjectNode();</span>

<span class="pc bpc" id="L482" title="1 of 8 branches missed.">        if (userAppRelation == null || userAppRelation.getId() == null || userAppRelation.getUser() == null || userAppRelation.getApp() == null) {</span>
<span class="fc" id="L483">            throw new IllegalArgumentException(&quot;UserAppRelation invalid&quot;);</span>
        }
<span class="fc" id="L485">        userAppRelationJson.put(&quot;id&quot;, userAppRelation.getId().toString());</span>
<span class="fc" id="L486">        userAppRelationJson.put(&quot;userName&quot;, userAppRelation.getUser().getName());</span>
<span class="fc" id="L487">        userAppRelationJson.put(&quot;userId&quot;, userAppRelation.getUser().getId().toString());</span>
<span class="fc" id="L488">        userAppRelationJson.put(&quot;appName&quot;, userAppRelation.getApp().getName());</span>
<span class="fc" id="L489">        userAppRelationJson.put(&quot;appId&quot;, userAppRelation.getApp().getId().toString());</span>

<span class="fc" id="L491">        String[] consenses = userAppRelation.getConsenses();</span>
<span class="fc bfc" id="L492" title="All 2 branches covered.">        if (consenses != null) {</span>
<span class="fc" id="L493">            ArrayNode consensesArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L494" title="All 2 branches covered.">            for (String consens : consenses) {</span>
<span class="fc" id="L495">                consensesArray.add(consens);</span>
            }
<span class="fc" id="L497">            userAppRelationJson.set(&quot;consenses&quot;, consensesArray);</span>
        }
<span class="fc" id="L499">        return userAppRelationJson;</span>
    }

    // Message

    /**
     * @param message object to be transformed in JSON
     * @return JSON representing message
     * @throws IllegalArgumentException if invalid object
     */
    public ObjectNode createJsonFromMessage(Message message) throws IllegalArgumentException {
<span class="fc" id="L510">        ObjectNode messageJson = mapper.createObjectNode();</span>
        try{
<span class="fc" id="L512">            messageJson.put(&quot;id&quot;, message.getId().toString());</span>
<span class="fc" id="L513">            messageJson.put(&quot;senderId&quot;, message.getSender().getId().toString());</span>
<span class="fc" id="L514">            messageJson.put(&quot;senderName&quot;, message.getSender().getName());</span>
<span class="fc" id="L515">            messageJson.put(&quot;receiverId&quot;, message.getReceiver().getId().toString());</span>
<span class="fc" id="L516">            messageJson.put(&quot;receiverName&quot;, message.getReceiver().getName());</span>
<span class="fc" id="L517">            messageJson.put(&quot;text&quot;, message.getMessage());</span>
<span class="fc" id="L518">            messageJson.put(&quot;time&quot;, message.getTime().toString());</span>
<span class="fc" id="L519">            return messageJson;</span>
        }
<span class="fc" id="L521">        catch(Exception e){</span>
<span class="fc" id="L522">            throw new IllegalArgumentException(&quot;Message invalid&quot;);</span>
        }
    }

    /**
     * @param body the JSON body from the POST request
     * @return the message object represented by the JSON
     * @throws IOException              If body is not a valid JSON
     * @throws IllegalArgumentException If the JSON does not contain senderId, receiverId or text
     * @throws IllegalArgumentException If the indicated ID is an invalid UUID
     * @throws DateTimeParseException   If time is invalid
     */
    public Message getMessageFromJsonString(String body) throws IllegalArgumentException, IOException, DateTimeParseException {
        try {
<span class="fc" id="L536">            JsonNode rootNode = mapper.readTree(new StringReader(body));</span>
<span class="fc" id="L537">            return getMessageFromJsonNode(rootNode);</span>
<span class="fc" id="L538">        } catch (IOException e){</span>
<span class="fc" id="L539">            throw new IOException(&quot;invalid JSON&quot;);</span>
<span class="fc" id="L540">        } catch (DateTimeParseException e){</span>
<span class="fc" id="L541">            throw e;</span>
<span class="fc" id="L542">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L543">            throw new IllegalArgumentException(&quot;invalid JSON parameters&quot;);</span>
        }
    }

    /**
     * @param node the JSON object to be turned into a message object.
     * @return the message object represented by the JSON
     * @throws IllegalArgumentException If the JSON does not contain senderId, receiverId or text
     * @throws IllegalArgumentException If the indicated ID is an invalid UUID
     * @throws DateTimeParseException   If time is invalid
     */
    public Message getMessageFromJsonNode(JsonNode node) throws IllegalArgumentException, DateTimeParseException {
<span class="fc" id="L555">        Message message = new Message();</span>
<span class="fc bfc" id="L556" title="All 6 branches covered.">        if (!node.has(&quot;senderId&quot;) || !node.has(&quot;receiverId&quot;) || !node.has(&quot;text&quot;)) {</span>
<span class="fc" id="L557">            throw new IllegalArgumentException(&quot;JSON incomplete&quot;);</span>
        }

<span class="fc bfc" id="L560" title="All 2 branches covered.">        if (node.has(&quot;id&quot;)) {</span>
<span class="fc" id="L561">            message.setId(UUID.fromString(node.get(&quot;id&quot;).asText()));</span>
        }

<span class="fc bfc" id="L564" title="All 2 branches covered.">        if (node.has(&quot;time&quot;)) {</span>
<span class="fc" id="L565">            message.setTime(LocalDateTime.parse(node.get(&quot;time&quot;).asText()));</span>
        }

<span class="fc" id="L568">        message.setMessage(node.get(&quot;text&quot;).asText());</span>

<span class="fc" id="L570">        Optional&lt;User&gt; sender = dataBaseService.getUser(UUID.fromString(node.get(&quot;senderId&quot;).asText()));</span>
<span class="fc bfc" id="L571" title="All 2 branches covered.">        if (sender.isEmpty()) {</span>
<span class="fc" id="L572">            throw new IllegalArgumentException(&quot;sender does not exist&quot;);</span>
        }
<span class="fc" id="L574">        message.setSender(sender.get());</span>

<span class="fc" id="L576">        Optional&lt;User&gt; receiver = dataBaseService.getUser(UUID.fromString(node.get(&quot;receiverId&quot;).asText()));</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">        if (receiver.isEmpty()) {</span>
<span class="fc" id="L578">            throw new IllegalArgumentException(&quot;receiver does not exist&quot;);</span>
        }
<span class="fc" id="L580">        message.setReceiver(receiver.get());</span>
<span class="fc" id="L581">        return message;</span>
    }

    // Privacy Notice

    /**
     * @param privacyNotice object to be transformed into json
     * @return Json associated with Privacy Notice
     * @throws IllegalArgumentException if PrivacyNotice has not id, app or text
     */
    public JsonNode createJsonFromPrivacyNotice(PrivacyNotice privacyNotice) throws IllegalArgumentException {
<span class="fc" id="L592">        ObjectNode privacyNoticeJson = mapper.createObjectNode();</span>
<span class="fc bfc" id="L593" title="All 6 branches covered.">        if (privacyNotice.getId() == null || privacyNotice.getText() == null || privacyNotice.getApp() == null) {</span>
<span class="fc" id="L594">            throw new IllegalArgumentException(&quot;invalid privacy notice&quot;);</span>
        }
<span class="fc" id="L596">        privacyNoticeJson.put(&quot;id&quot;, privacyNotice.getId().toString());</span>
<span class="fc" id="L597">        privacyNoticeJson.put(&quot;appname&quot;, privacyNotice.getApp().getName());</span>
<span class="fc" id="L598">        privacyNoticeJson.put(&quot;appId&quot;, privacyNotice.getApp().getId().toString());</span>
<span class="fc" id="L599">        privacyNoticeJson.put(&quot;text&quot;, privacyNotice.getText());</span>
<span class="fc" id="L600">        return privacyNoticeJson;</span>
    }

    /**
     * @param mandatoryParameters specify if the appId MUST be included (true) or not (false)
     * @param body                JSON representing the Privacy Notice
     * @return Privacy Notice
     * @throws IllegalArgumentException if invalid app does not exist, invalid JSON
     * @throws IOException              if invalid JSON
     */
    public PrivacyNotice getPrivacyNoticeFromJsonString(boolean mandatoryParameters, String body) throws IllegalArgumentException, IOException {
        try {
<span class="fc" id="L612">            JsonNode rootNode = mapper.readTree(new StringReader(body));</span>
<span class="fc" id="L613">            return getPrivacyNoticeFromJsonNode(mandatoryParameters, rootNode);</span>
<span class="fc" id="L614">        } catch (IOException e){</span>
<span class="fc" id="L615">            throw new IOException(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * @param mandatoryParameters specify if the appId MUST be included (true) or not (false)
     * @param node                JSON representing the Privacy Notice
     * @return Privacy Notice
     * @throws IllegalArgumentException if invalid app does not exist, invalid JSON
     */
    public PrivacyNotice getPrivacyNoticeFromJsonNode(boolean mandatoryParameters, JsonNode node) throws IllegalArgumentException {
<span class="fc" id="L626">        PrivacyNotice privacyNotice = new PrivacyNotice();</span>
<span class="fc bfc" id="L627" title="All 2 branches covered.">        if (node.has(&quot;appId&quot;)) {</span>
<span class="fc" id="L628">            privacyNotice.setApp(getAppFromId(node.get(&quot;appId&quot;).asText()));</span>
<span class="fc bfc" id="L629" title="All 2 branches covered.">        } else if (mandatoryParameters) {</span>
<span class="fc" id="L630">            throw new IllegalArgumentException(&quot;missing appId&quot;);</span>
        }

<span class="fc bfc" id="L633" title="All 2 branches covered.">        if (node.has(&quot;text&quot;)) {</span>
<span class="fc" id="L634">            privacyNotice.setText(node.get(&quot;text&quot;).asText());</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">        } else if (mandatoryParameters) {</span>
<span class="fc" id="L636">            throw new IllegalArgumentException(&quot;missing appId&quot;);</span>
        }
<span class="fc" id="L638">        return privacyNotice;</span>
    }

    // Notification

    /**
     * @param notification object to be transformed into json
     * @return Json associated with Notification
     * @throws IllegalArgumentException if Notification has not id, senderId, receiverId, type, objectId
     */
    public JsonNode createJsonFromNotification(Notification notification) throws IllegalArgumentException {
<span class="fc" id="L649">        ObjectNode notificationJson = mapper.createObjectNode();</span>
<span class="fc bfc" id="L650" title="All 10 branches covered.">        if (notification.getId() == null || notification.getReceiver() == null || notification.getSender() == null || notification.getType()==null || notification.getObjectId()==null) {</span>
<span class="fc" id="L651">            throw new IllegalArgumentException(&quot;invalid notification&quot;);</span>
        }
<span class="fc" id="L653">        notificationJson.put(&quot;id&quot;, notification.getId().toString());</span>
<span class="fc" id="L654">        notificationJson.put(&quot;senderId&quot;, notification.getSender().getId().toString());</span>
<span class="fc" id="L655">        notificationJson.put(&quot;senderName&quot;, notification.getSender().getName());</span>
<span class="fc" id="L656">        notificationJson.put(&quot;receiverId&quot;, notification.getReceiver().getId().toString());</span>
<span class="fc" id="L657">        notificationJson.put(&quot;receiverName&quot;, notification.getReceiver().getName());</span>
<span class="fc" id="L658">        notificationJson.put(&quot;description&quot;, notification.getDescription());</span>
<span class="fc" id="L659">        notificationJson.put(&quot;type&quot;, notification.getType());</span>
<span class="fc" id="L660">        notificationJson.put(&quot;objectId&quot;, notification.getObjectId().toString());</span>

<span class="fc bfc" id="L662" title="All 2 branches covered.">        if(notification.getTime()!=null){</span>
<span class="fc" id="L663">            notificationJson.put(&quot;time&quot;, notification.getTime().toString());</span>
        }
<span class="fc bfc" id="L665" title="All 2 branches covered.">        if(notification.getRead()!=null){</span>
<span class="fc" id="L666">            notificationJson.put(&quot;isRead&quot;, notification.getRead());</span>
        }
<span class="fc" id="L668">        return notificationJson;</span>
    }

    /**
     * @param user User to get Notifications from
     * @param all All the notification?
     * @param isRead if all==false, isRead notification or not
     * @return JSON representing all the notifications
     */
    public ArrayNode createJsonNotificationsFromUser(User user, boolean all, boolean isRead){
        List&lt;Notification&gt; notificationList;
<span class="fc bfc" id="L679" title="All 2 branches covered.">        if(all){</span>
<span class="fc" id="L680">            notificationList= dataBaseService.getNotificationsFromUser(user);</span>
        }
        else{
<span class="fc bfc" id="L683" title="All 2 branches covered.">            if(isRead){</span>
<span class="fc" id="L684">                notificationList= dataBaseService.getOldNotificationsFromUser(user);</span>
            }
            else{
<span class="fc" id="L687">                notificationList= dataBaseService.getNewNotificationsFromUser(user);</span>
            }
        }
<span class="fc" id="L690">        ArrayNode notificationArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L691" title="All 2 branches covered.">        for(Notification notification : notificationList){</span>
<span class="fc" id="L692">            notificationArray.add(createJsonFromNotification(notification));</span>
<span class="fc" id="L693">        }</span>
<span class="fc" id="L694">        return notificationArray;</span>
    }

    /**
     *
     * @param body JSON representing the Notification
     * @return Notification
     * @throws IllegalArgumentException if JSONObject has not id, senderId, receiverId, type, objectId
     * @throws IOException if invalid JSON
     */
    public Notification getNotificationFromJsonString(String body) throws IllegalArgumentException, IOException{
        try {
<span class="fc" id="L706">            JsonNode rootNode = mapper.readTree(new StringReader(body));</span>
<span class="fc" id="L707">            return getNotificationFromJsonNode(rootNode);</span>
<span class="fc" id="L708">        } catch (IOException e){</span>
<span class="fc" id="L709">            throw new IOException(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * @param node JSON representing the Notification
     * @return Notification
     * @throws IllegalArgumentException if JSONObject has not senderId, receiverId, type, objectId. If object does not exist or is wrong type
     */
    public Notification getNotificationFromJsonNode(JsonNode node) throws IllegalArgumentException {
<span class="fc" id="L719">        Notification notification= new Notification();</span>
<span class="fc bfc" id="L720" title="All 8 branches covered.">        if(!node.has(&quot;senderId&quot;) || !node.has(&quot;receiverId&quot;) || !node.has(&quot;type&quot;) || !node.has(&quot;objectId&quot;)){</span>
<span class="fc" id="L721">            throw new IllegalArgumentException(&quot;missing mandatory parameters in the JSON object&quot;);</span>
        }
<span class="fc" id="L723">        notification.setSender(getUserFromId(node.get(&quot;senderId&quot;).asText()));</span>
<span class="fc" id="L724">        notification.setReceiver(getUserFromId(node.get(&quot;receiverId&quot;).asText()));</span>

        // check if type is correct for the objectId
<span class="fc" id="L727">        String type=node.get(&quot;type&quot;).asText();</span>
<span class="fc bfc" id="L728" title="All 2 branches covered.">        if(GlobalVariables.notificationType.contains(type)){</span>
<span class="pc bpc" id="L729" title="1 of 4 branches missed.">            switch (type){</span>
                case &quot;Message&quot;:
<span class="fc" id="L731">                    Message message= getMessageFromId(node.get(&quot;objectId&quot;).asText()); break;</span>
                case &quot;Request&quot;:
<span class="fc" id="L733">                    RightRequest request= getRequestFromId(node.get(&quot;objectId&quot;).asText()); break;</span>
                case &quot;PrivacyNotice&quot;:
<span class="fc" id="L735">                    PrivacyNotice privacyNotice= getPrivacyNoticeFromId(node.get(&quot;objectId&quot;).asText()); break;</span>
            }
        }
<span class="fc" id="L738">        notification.setType(type);</span>
        try {
<span class="fc" id="L740">            notification.setObjectId(UUID.fromString(node.get(&quot;objectId&quot;).asText()));</span>
<span class="fc" id="L741">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L742">            throw new IllegalArgumentException(&quot;invalid object ID&quot;);</span>
<span class="fc" id="L743">        }</span>

<span class="fc bfc" id="L745" title="All 2 branches covered.">        if(node.has(&quot;description&quot;)){</span>
<span class="fc" id="L746">            notification.setDescription(node.get(&quot;description&quot;).asText());</span>
        }

<span class="fc bfc" id="L749" title="All 2 branches covered.">        if(node.has(&quot;isRead&quot;)){</span>
<span class="fc" id="L750">            notification.setRead(node.get(&quot;isRead&quot;).asBoolean());</span>
        }

<span class="fc bfc" id="L753" title="All 2 branches covered.">        if(node.has(&quot;time&quot;)){</span>
<span class="fc" id="L754">            notification.setTime(LocalDateTime.parse(node.get(&quot;time&quot;).asText()));</span>
        }
<span class="fc" id="L756">        return notification;</span>
    }

    //  RightRequest

    /**
     * @param request object to be represented in JSON
     * @return JSON representing that request
     * @throws IllegalArgumentException if request does not exist or is invalid
     */
    public JsonNode createJsonFromRequest(RightRequest request) throws IllegalArgumentException{
<span class="fc" id="L767">        ObjectNode requestJson = mapper.createObjectNode();</span>
<span class="fc bfc" id="L768" title="All 8 branches covered.">        if(request.getId()==null || request.getSender()==null || request.getReceiver()==null || request.getRightType()==null){</span>
<span class="fc" id="L769">            throw new IllegalArgumentException(&quot;invalid right request&quot;);</span>
        }

<span class="fc" id="L772">        requestJson.put(&quot;id&quot;, request.getId().toString());</span>
<span class="fc" id="L773">        requestJson.put(&quot;senderName&quot;, request.getSender().getName());</span>
<span class="fc" id="L774">        requestJson.put(&quot;senderId&quot;, request.getSender().getId().toString());</span>
<span class="fc" id="L775">        requestJson.put(&quot;receiverName&quot;, request.getReceiver().getName());</span>
<span class="fc" id="L776">        requestJson.put(&quot;receiverId&quot;, request.getReceiver().getId().toString());</span>
<span class="fc bfc" id="L777" title="All 2 branches covered.">        if(request.getTime()!=null){</span>
<span class="fc" id="L778">            requestJson.put(&quot;time&quot;, request.getTime().toString());</span>
        }
<span class="fc bfc" id="L780" title="All 2 branches covered.">        if(request.getApp()!=null){</span>
<span class="fc" id="L781">            requestJson.put(&quot;appId&quot;, request.getApp().getId().toString());</span>
<span class="fc" id="L782">            requestJson.put(&quot;appName&quot;, request.getApp().getName());</span>
        }
<span class="fc" id="L784">        requestJson.put(&quot;rightType&quot;, request.getRightType().toString());</span>
<span class="fc bfc" id="L785" title="All 2 branches covered.">        if(request.getOther()!=null){</span>
<span class="fc" id="L786">            requestJson.put(&quot;other&quot;, request.getOther());</span>
        }
<span class="fc bfc" id="L788" title="All 2 branches covered.">        if(request.getHandled()!=null){</span>
<span class="fc" id="L789">            requestJson.put(&quot;handled&quot;, request.getHandled());</span>
        }
<span class="fc bfc" id="L791" title="All 2 branches covered.">        if(request.getDetails()!=null){</span>
<span class="fc" id="L792">            requestJson.put(&quot;details&quot;, request.getDetails());</span>
        }
<span class="fc bfc" id="L794" title="All 2 branches covered.">        if(request.getResponse()!=null){</span>
<span class="fc" id="L795">            requestJson.put(&quot;response&quot;, request.getResponse());</span>
        }
<span class="fc" id="L797">        return requestJson;</span>
    }

    /**
     * @return JSON representing the requests in the request list that have the sender or the receiver equals to the parameter user
     */
    public ArrayNode createJsonRequestCheckAuthorizedUser(List&lt;RightRequest&gt; requestList, User user){
<span class="fc" id="L804">        ArrayNode requestArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L805" title="All 2 branches covered.">        for(RightRequest request : requestList){</span>
<span class="fc bfc" id="L806" title="All 4 branches covered.">            if(request.getSender().equals(user) || request.getReceiver().equals(user)){</span>
<span class="fc" id="L807">                requestArray.add(createJsonFromRequest(request));</span>
            }
<span class="fc" id="L809">        }</span>
<span class="fc" id="L810">        return requestArray;</span>
    }

    /**
     * @return JSON representing the requests in the request list that have the app equals to the parameter app
     */
    public ArrayNode createJsonRequestOfApp(List&lt;RightRequest&gt; requestList, IoTApp app){
<span class="fc" id="L817">        ArrayNode requestArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L818" title="All 2 branches covered.">        for(RightRequest request : requestList){</span>
<span class="fc bfc" id="L819" title="All 2 branches covered.">            if(request.getApp().equals(app)){</span>
<span class="fc" id="L820">                requestArray.add(createJsonFromRequest(request));</span>
            }
<span class="fc" id="L822">        }</span>
<span class="fc" id="L823">        return requestArray;</span>
    }

    /**
     * @return JSON representing the requests in the request list that have the rightType equals to the parameter rightTypeString
     */
    public ArrayNode createJsonRequestOfRightType(List&lt;RightRequest&gt; requestList, String rightTypeString) throws IllegalArgumentException{
        RightType rightType;
        try {
<span class="fc" id="L832">            rightType = RightType.valueOf(rightTypeString.toUpperCase());</span>
<span class="fc" id="L833">        } catch (IllegalArgumentException e){</span>
<span class="fc" id="L834">            throw new IllegalArgumentException(&quot;invalid Right Type&quot;);</span>
<span class="fc" id="L835">        }</span>
<span class="fc" id="L836">        ArrayNode requestArray = mapper.createArrayNode();</span>
<span class="fc bfc" id="L837" title="All 2 branches covered.">        for(RightRequest request : requestList){</span>
<span class="fc bfc" id="L838" title="All 2 branches covered.">            if(request.getRightType().equals(rightType)){</span>
<span class="fc" id="L839">                requestArray.add(createJsonFromRequest(request));</span>
            }
<span class="fc" id="L841">        }</span>
<span class="fc" id="L842">        return requestArray;</span>
    }

    /**
     * @param body JSON representing the Request
     * @param mandatoryParameters specify if senderID, receiverId, rightType and objectId must be included
     * @return Request
     * @throws IllegalArgumentException if JSONObject has not senderId, receiverId, rightType, objectId. If object does not exist or is wrong type
     * @throws IOException if invalid JSON
     */
    public RightRequest getRequestFromJsonString(String body, boolean mandatoryParameters) throws IllegalArgumentException, IOException{
        try {
<span class="fc" id="L854">            JsonNode rootNode = mapper.readTree(new StringReader(body));</span>
<span class="fc" id="L855">            return getRequestFromJsonNode(rootNode, mandatoryParameters);</span>
<span class="fc" id="L856">        } catch (IOException e){</span>
<span class="fc" id="L857">            throw new IOException(&quot;invalid JSON&quot;);</span>
        }
    }

    /**
     * @param node JSON representing the Request
     * @param mandatoryParameters specify if senderID, appId, rightType must be included
     * @return Request
     * @throws IllegalArgumentException if JSONObject has not senderId, receiverId, rightType. If object does not exist or is wrong type
     */
    public RightRequest getRequestFromJsonNode(JsonNode node, boolean mandatoryParameters) throws IllegalArgumentException {
<span class="fc" id="L868">        RightRequest request = new RightRequest();</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">        if(node.has(&quot;senderId&quot;)){</span>
<span class="fc" id="L870">            request.setSender(getUserFromId(node.get(&quot;senderId&quot;).asText()));</span>
        }
<span class="fc bfc" id="L872" title="All 2 branches covered.">        else if(mandatoryParameters){</span>
<span class="fc" id="L873">            throw new IllegalArgumentException(&quot;senderId value missing&quot;);</span>
        }

<span class="fc bfc" id="L876" title="All 2 branches covered.">        if(node.has(&quot;appId&quot;)){</span>
<span class="fc" id="L877">            request.setApp(getAppFromId(node.get(&quot;appId&quot;).asText()));</span>
        }
<span class="fc bfc" id="L879" title="All 2 branches covered.">        else if(mandatoryParameters ){</span>
<span class="fc" id="L880">            throw new IllegalArgumentException(&quot;appId value missing&quot;);</span>
        }

<span class="fc bfc" id="L883" title="All 2 branches covered.">        if(node.has(&quot;receiverId&quot;)){</span>
<span class="fc" id="L884">            request.setReceiver(getUserFromId(node.get(&quot;receiverId&quot;).asText()));</span>
        }

<span class="fc bfc" id="L887" title="All 2 branches covered.">        if(node.has(&quot;rightType&quot;)){</span>
<span class="fc" id="L888">            request.setRightType(RightType.valueOf(node.get(&quot;rightType&quot;).asText()));</span>
        }
<span class="fc bfc" id="L890" title="All 2 branches covered.">        else if(mandatoryParameters){</span>
<span class="fc" id="L891">            throw new IllegalArgumentException(&quot;rightType value missing&quot;);</span>
        }

<span class="fc bfc" id="L894" title="All 2 branches covered.">        if(node.has(&quot;time&quot;)){</span>
            try{
<span class="fc" id="L896">                request.setTime(LocalDateTime.parse(node.get(&quot;time&quot;).asText()));</span>
<span class="fc" id="L897">            } catch (DateTimeParseException e){</span>
<span class="fc" id="L898">                throw new IllegalArgumentException(&quot;invalid date&quot;);</span>
<span class="fc" id="L899">            }</span>
        }
<span class="fc bfc" id="L901" title="All 2 branches covered.">        if(node.has(&quot;other&quot;)){</span>
<span class="fc" id="L902">            request.setOther(node.get(&quot;other&quot;).asText());</span>
        }
<span class="fc bfc" id="L904" title="All 2 branches covered.">        if(node.has(&quot;details&quot;)){</span>
<span class="fc" id="L905">            request.setDetails(node.get(&quot;details&quot;).asText());</span>
        }
<span class="fc bfc" id="L907" title="All 2 branches covered.">        if(node.has(&quot;response&quot;)){</span>
<span class="fc" id="L908">            request.setResponse(node.get(&quot;response&quot;).asText());</span>
        }
<span class="fc bfc" id="L910" title="All 2 branches covered.">        if(node.has(&quot;handled&quot;)){</span>
<span class="fc bfc" id="L911" title="All 4 branches covered.">            if(node.get(&quot;handled&quot;).asText().equalsIgnoreCase(&quot;true&quot;) || node.get(&quot;handled&quot;).asText().equalsIgnoreCase(&quot;false&quot;)){</span>
<span class="fc" id="L912">                request.setHandled(node.get(&quot;handled&quot;).asBoolean());</span>
            }
        }
<span class="fc" id="L915">        return request;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>